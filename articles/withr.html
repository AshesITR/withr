<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>withr • withr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="withr">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">withr</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">2.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="../articles/releases/withr-2.1.0.html">Version 2.1.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/r-lib/withr#readme">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>withr</h1>
                        <h4 class="author">Jim Hester</h4>
            
            <h4 class="date">2018-05-25</h4>
      
      <small class="dont-index">Source: <a href="http://github.com/r-lib/withr#readme/blob/master/vignettes/withr.Rmd"><code>vignettes/withr.Rmd</code></a></small>
      <div class="hidden name"><code>withr.Rmd</code></div>

    </div>

    
    
<div id="whither-withr" class="section level1">
<h1 class="hasAnchor">
<a href="#whither-withr" class="anchor"></a>Whither withr?</h1>
<p>Many functions in R modify global state in some fashion. Some common examples are <code>par()</code> for graphics parameters, <code>dir()</code> to change the current directory and <code>options()</code> to set a global option. Using these functions is handy when using R interactively, because you can set them early in your experimentation and they will remain set for the duration of the session. However this makes programming with these settings difficult, because they make your function impure by modifying a global state. Therefore you should always strive to reset the previous state when the function exits.</p>
<p>One common idiom for dealing with this problem is to save the current state, make your change, then restore the previous state.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  old &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw">plot</span>(mtcars<span class="op">$</span>hp, mtcars<span class="op">$</span>wt)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="kw">par</span>(old)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">my_plot</span>()</a></code></pre></div>
<p><img src="withr_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">par</span>(<span class="st">"col"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt; [1] "black"</span></a></code></pre></div>
<p>However this approach can fail if there’s an error before you are able to reset the options.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  old &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="kw">plot</span>(mtcars<span class="op">$</span>hpp, mtcars<span class="op">$</span>wt)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="kw">par</span>(old)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">my_plot</span>()</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; Error in xy.coords(x, y, xlabel, ylabel, log): 'x' and 'y' lengths differ</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">par</span>(<span class="st">"col"</span>)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; [1] "red"</span></a></code></pre></div>
<p>Using the base function <code>on.exit()</code> is a robust solution to this problem. <code>on.exit()</code> will run the code when the function is exited, regardless of whether it exits normally or with an error.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  old &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="kw">on.exit</span>(<span class="kw">par</span>(old))</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="kw">plot</span>(mtcars<span class="op">$</span>hpp, mtcars<span class="op">$</span>wt)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">my_plot</span>()</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; Error in xy.coords(x, y, xlabel, ylabel, log): 'x' and 'y' lengths differ</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="kw">par</span>(<span class="st">"col"</span>)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; [1] "black"</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw">options</span>(<span class="dt">test =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">{</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="kw">print</span>(<span class="kw">getOption</span>(<span class="st">"test"</span>))</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="kw">on.exit</span>(<span class="kw">options</span>(<span class="dt">test =</span> <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; [1] 1</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="kw">getOption</span>(<span class="st">"test"</span>)</a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; [1] 2</span></a></code></pre></div>
<p>However this solution is somewhat cumbersome to work with. You need to remember to use an <code>on.exit()</code> call after each stateful call. In addition by default each <code>on.exit()</code> action will overwrite any previous <code>on.exit()</code> action in the same function unless you use the <code>add = TRUE</code> option. <code>add = TRUE</code> also adds additional code to the <em>end</em> of existing code, which means the code is not run in the <a href="https://en.wikipedia.org/wiki/FIFO_and_LIFO_accounting">Last-In, First-Out</a> order you would generally prefer. It is also not possible to have this cleanup code performed before the function has finished.</p>
<p><a href="http://withr.r-lib.org">withr</a> is a solution to these issues. It defines a <a href="http://withr.r-lib.org/#withr---run-code-with-modified-state">large set of functions</a> for dealing with global settings in R, such as <code><a href="../reference/with_par.html">with_par()</a></code>. These functions set one of the global settings for the duration of a block of code, then automatically reset it after the block is completed.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="kw"><a href="../reference/with_par.html">with_par</a></span>(<span class="kw">list</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>),</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="kw">plot</span>(mtcars<span class="op">$</span>hp, mtcars<span class="op">$</span>wt)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  )</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="kw">par</span>(<span class="st">"col"</span>)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="kw">my_plot</span>()</a></code></pre></div>
<p><img src="withr_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<pre><code>#&gt; [1] "black"
par("col")
#&gt; [1] "black"</code></pre>
<p>In addition to the <code>with_*</code> functions there are <code>local_*</code> variants whose effects last until the end of the function they are included in. These work similar to <code>on.exit()</code>, but you can set the options in one call rather than two.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="kw"><a href="../reference/with_par.html">local_par</a></span>(<span class="kw">list</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>))</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="kw">plot</span>(mtcars<span class="op">$</span>hp, mtcars<span class="op">$</span>wt)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">my_plot</span>()</a></code></pre></div>
<p><img src="withr_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">par</span>(<span class="st">"col"</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; [1] "black"</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#whither-withr">Whither withr?</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://jimhester.com">Jim Hester</a>, Kirill Müller, Kevin Ushey, <a href="http://hadley.nz">Hadley Wickham</a>, Winston Chang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
