<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>withr 2.1.0 • withr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">withr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">Home</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="../../articles/releases/withr-2.1.0.html">Version 2.1.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../../news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/r-lib/withr#readme">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>withr 2.1.0</h1>
                        <h4 class="author">Jim Hester</h4>
            
            <h4 class="date">2017-11-16</h4>
          </div>

    
    
<div class="contents">
<p><a href="http://withr.tidyverse.org/news/index.html">withr 2.1.0</a> is now available on CRAN! <a href="http://withr.r-lib.org">withr</a> makes working with global state in R safer and less error prone. It has only base package dependencies so is easily included in packages.</p>
<p>Install the latest version with:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">"withr"</span>)</code></pre></div>
<div id="whither-withr" class="section level1">
<h1 class="hasAnchor">
<a href="#whither-withr" class="anchor"></a>Whither withr?</h1>
<p>Many functions in R modify global state in some fashion. Some common examples are <code>par()</code> for graphics parameters, <code>dir()</code> to change the current directory and <code>options()</code> to set a global option. Using these functions is handy when using R interactively, because you can set them early in your experimentation and they will remain set for the duration of the session. However this makes programming with these settings difficult, because they make your function impure by modifying a global state. Therefore you should always strive to reset the previous state when the function exists.</p>
<p>One common idiom for dealing with this problem is to save the current state, make your change, then restore the previous state.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)
my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {
  old &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>)
  <span class="kw">plot</span>(mtcars<span class="op">$</span>hp, mtcars<span class="op">$</span>wt)
  <span class="kw">par</span>(old)
}
<span class="kw">my_plot</span>()</code></pre></div>
<p><img src="withr-2.1.0_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span>)</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] "black"
</pre>
</div>
<p>However this approach can fail if there’s an error before you are able to reset the options.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)
my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {
  old &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>)
  <span class="kw">plot</span>(mtcars<span class="op">$</span>hpp, mtcars<span class="op">$</span>wt)
  <span class="kw">par</span>(old)
}
<span class="kw">my_plot</span>()</code></pre></div>
<div class="error">
<pre class="knitr r">#&gt; Error in xy.coords(x, y, xlabel, ylabel, log): 'x' and 'y' lengths differ
</pre>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span>)</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] "red"
</pre>
</div>
<p>Using the base function <code>on.exit()</code> is a robust solution to this problem. <code>on.exit()</code> will run the code when the function is exited, regardless whether it exits normally or with an error.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)
my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {
  old &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>)
  <span class="kw">on.exit</span>(<span class="kw">par</span>(old))
  <span class="kw">plot</span>(mtcars<span class="op">$</span>hpp, mtcars<span class="op">$</span>wt)
}
<span class="kw">my_plot</span>()</code></pre></div>
<div class="error">
<pre class="knitr r">#&gt; Error in xy.coords(x, y, xlabel, ylabel, log): 'x' and 'y' lengths differ
</pre>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span>)</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] "black"
</pre>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw">options</span>(<span class="dt">test =</span> <span class="dv">1</span>)
{
  <span class="kw">print</span>(<span class="kw">getOption</span>(<span class="st">"test"</span>))
  <span class="kw">on.exit</span>(<span class="kw">options</span>(<span class="dt">test =</span> <span class="dv">2</span>))
}</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] 1
</pre>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">getOption</span>(<span class="st">"test"</span>)</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] 2
</pre>
</div>
<p>However this solution is somewhat cumbersome to work with. You need to remember to use an <code>on.exit()</code> call after each stateful call. In addition by default each <code>on.exit()</code> action will overwrite any previous <code>on.exit()</code> action in the same function unless you use the <code>add = TRUE</code> option. <code>add = TRUE</code> also adds additional code to the <em>end</em> of existing code, which means the code is not run in the <a href="https://en.wikipedia.org/wiki/FIFO_and_LIFO_accounting">First-In First-Out</a> order you would generally prefer. It is also not possible to have this cleanup code performed before the function has finished.</p>
<p><a href="http://withr.r-lib.org">withr</a> is a solution to these issues. It defines a <a href="http://withr.r-lib.org/#withr---run-code-with-modified-state">large set of functions</a> for dealing with global settings in R, such as <code><a href="../../reference/with_par.html">with_par()</a></code>. These functions set one of the global settings for the duration of a block of code, then automatically reset it after the block is completed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)
my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {
  <span class="kw"><a href="../../reference/with_par.html">with_par</a></span>(<span class="kw">list</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>),
    <span class="kw">plot</span>(mtcars<span class="op">$</span>hp, mtcars<span class="op">$</span>wt)
  )
  <span class="kw">par</span>(<span class="st">"col"</span>)
}
<span class="kw">my_plot</span>()</code></pre></div>
<img src="withr-2.1.0_files/figure-html/unnamed-chunk-5-1.png" width="672"><div class="output">
<pre class="knitr r">#&gt; [1] "black"
</pre>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span>)</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] "black"
</pre>
</div>
<p>In addition to the <code>with_*</code> functions there are <code>local_*</code> variants whose effects last until the end of the function they are included in. These work similar to <code>on.exit()</code>, but you can set the options in one call rather than two.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span> =<span class="st"> "black"</span>)
my_plot &lt;-<span class="st"> </span><span class="cf">function</span>(new) {
  <span class="kw"><a href="../../reference/with_par.html">local_par</a></span>(<span class="kw">list</span>(<span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">19</span>))
  <span class="kw">plot</span>(mtcars<span class="op">$</span>hp, mtcars<span class="op">$</span>wt)
}
<span class="kw">my_plot</span>()</code></pre></div>
<p><img src="withr-2.1.0_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="st">"col"</span>)</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] "black"
</pre>
</div>
</div>
<div id="new-features" class="section level1">
<h1 class="hasAnchor">
<a href="#new-features" class="anchor"></a>New features</h1>
<p>Here are some highlights of new functions for v2.1.0.</p>
<div id="graphics-devices" class="section level2">
<h2 class="hasAnchor">
<a href="#graphics-devices" class="anchor"></a>Graphics devices</h2>
<p>There are now a comprehensive set of functions to deal with R’s builtin <a href="http://withr.r-lib.org/reference/devices.html">graphics devices</a>.</p>
<p>These functions open a new graphics device, run some code, then automatically close the device.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">Sys.glob</span>(<span class="st">"*withr*_files/figure-html"</span>), <span class="st">"test.png"</span>)
<span class="kw"><a href="../../reference/devices.html">with_png</a></span>(path, <span class="dt">width =</span> <span class="dv">400</span>, <span class="dt">height =</span> <span class="dv">300</span>, {
  <span class="kw">plot</span>(mtcars<span class="op">$</span>hp, mtcars<span class="op">$</span>mpg)
})</code></pre></div>
<div class="figure">
<img src="withr-2.1.0_files/figure-html/test.png">
</div>
<p>Thanks to <a href="https://github.com/richierocks">Richard Cotton’s</a> great <a href="https://github.com/r-lib/withr/pull/37">pull request</a> for this feature!</p>
</div>
<div id="connections" class="section level2">
<h2 class="hasAnchor">
<a href="#connections" class="anchor"></a>Connections</h2>
<p>There are two new functions for cleaning up connections in R. <code><a href="../../reference/with_connection.html">with_connection()</a></code> allows you to automatically close R’s file connections. Here we create a writable file connection, write some lines to it with <code><a href="../../reference/with_connection.html">with_connection()</a></code>, then open a read-only connection and read the file using <code><a href="../../reference/with_connection.html">local_connection()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../../reference/with_connection.html">with_connection</a></span>(<span class="kw">list</span>(<span class="dt">con =</span> <span class="kw">file</span>(<span class="st">"temp"</span>, <span class="st">"w"</span>)), {
  <span class="kw">writeLines</span>(<span class="kw">c</span>(<span class="st">"foo"</span>, <span class="st">"bar"</span>), con)
})
read_temp &lt;-<span class="st"> </span><span class="cf">function</span>() {
  con &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/with_connection.html">local_connection</a></span>(<span class="kw">file</span>(<span class="st">"temp"</span>, <span class="st">"r"</span>))
  <span class="kw">readLines</span>(con)
}
<span class="kw">read_temp</span>()</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] "foo" "bar"
</pre>
</div>
<p><code><a href="../../reference/with_db_connection.html">with_db_connection()</a></code> provides <a href="http://rstats-db.github.io/DBI">DBI</a> connections to databases which automatically call <code><a href="http://www.rdocumentation.org/packages/DBI/topics/dbDisconnect">DBI::dbDisconnect()</a></code>. Here we create a new <a href="https://www.sqlite.org/">SQLite</a> database, connect to it with <code><a href="../../reference/with_db_connection.html">with_db_connection()</a></code>, and write a new table to it. We then create another connection with <code><a href="../../reference/with_db_connection.html">local_db_connection()</a></code> and read from the table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">db &lt;-<span class="st"> </span><span class="kw">tempfile</span>()
<span class="kw"><a href="../../reference/with_db_connection.html">with_db_connection</a></span>(
  <span class="kw">list</span>(<span class="dt">con =</span> DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbConnect">dbConnect</a></span>(RSQLite<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RSQLite/topics/SQLite">SQLite</a></span>(), db)), {
    DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbWriteTable">dbWriteTable</a></span>(con, <span class="st">"mtcars"</span>, mtcars)
})</code></pre></div>
<div class="message">
<pre class="knitr r">#&gt; Loading required namespace: DBI
</pre>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
head_db_table &lt;-<span class="st"> </span><span class="cf">function</span>(...) {
  con &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/with_db_connection.html">local_db_connection</a></span>(DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbConnect">dbConnect</a></span>(RSQLite<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RSQLite/topics/SQLite">SQLite</a></span>(), db))
  <span class="kw">head</span>(DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbReadTable">dbReadTable</a></span>(con, <span class="st">"mtcars"</span>), ...)
}
<span class="kw">head_db_table</span>()</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt;    mpg cyl disp  hp drat    wt  qsec vs am gear carb
#&gt; 1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
#&gt; 2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
#&gt; 3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
#&gt; 4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
#&gt; 5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
#&gt; 6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1
</pre>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">unlink</span>(db)</code></pre></div>
</div>
<div id="packages" class="section level2">
<h2 class="hasAnchor">
<a href="#packages" class="anchor"></a>Packages</h2>
<p><code><a href="../../reference/with_package.html">with_package()</a></code> allows you to temporarily attach a package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../../reference/with_package.html">with_package</a></span>(<span class="st">"lattice"</span>, {
  <span class="kw">xyplot</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="op">-</span><span class="dv">2</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">y =</span> <span class="kw">dnorm</span>(<span class="op">-</span><span class="dv">2</span><span class="op">:</span><span class="dv">2</span>)))
})</code></pre></div>
<p><img src="withr-2.1.0_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
</div>
<div id="tempfiles" class="section level2">
<h2 class="hasAnchor">
<a href="#tempfiles" class="anchor"></a>Tempfiles</h2>
<p><code><a href="../../reference/with_tempfile.html">with_tempfile()</a></code> handy for creating a new temporary files that are removed, often useful when writing tests.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../../reference/with_tempfile.html">with_tempfile</a></span>(<span class="st">"file1"</span>, {
  <span class="kw">print</span>(file1)
  <span class="kw">writeLines</span>(<span class="st">"foo"</span>, file1)
  <span class="kw">readLines</span>(file1)
})</code></pre></div>
<div class="output">
<pre class="knitr r">#&gt; [1] "/var/folders/dt/r5s12t392tb5sk181j3gs4zw0000gn/T//Rtmpj94xe8/file75ed6f858638"
</pre>
</div>
<div class="output">
<pre class="knitr r">#&gt; [1] "foo"
</pre>
</div>
</div>
<div id="other-changes" class="section level2">
<h2 class="hasAnchor">
<a href="#other-changes" class="anchor"></a>Other changes</h2>
<p>There are many other bug fixes and other minor improvements in this release. You can see a complete list in the <a href="https://github.com/tidyverse/withr/releases/tag/v2.1.0">release notes</a>.</p>
<p>A big thanks goes to all the community members who contributed code and opened issues since the last release!</p>
<p><a href="https://github.com/QuLogic">@QuLogic</a>, <a href="https://github.com/krlmlr">@krlmlr</a>, <a href="https://github.com/hadley">@hadley</a>, <a href="https://github.com/wlandau-lilly">@wlandau-lilly</a>, <a href="https://github.com/jimhester">@jimhester</a>, <a href="https://github.com/kevinushey">@kevinushey</a>, and <a href="https://github.com/richierocks">@richierocks</a></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#whither-withr">Whither withr?</a></li>
      <li>
<a href="#new-features">New features</a><ul class="nav nav-pills nav-stacked">
<li><a href="#graphics-devices">Graphics devices</a></li>
      <li><a href="#connections">Connections</a></li>
      <li><a href="#packages">Packages</a></li>
      <li><a href="#tempfiles">Tempfiles</a></li>
      <li><a href="#other-changes">Other changes</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://jimhester.com">Jim Hester</a>, Kirill Müller, Kevin Ushey, <a href="http://hadley.nz">Hadley Wickham</a>, Winston Chang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
